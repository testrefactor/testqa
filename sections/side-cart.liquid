{{ 'section-side-cart.css' | asset_url | stylesheet_tag }}

<script src="{{ 'section-side-cart.js' | asset_url }}" defer></script>

{% assign one_percent_for_free_delivery = settings.total_price_for_free_delivery | divided_by: 100 %}
{% assign cart_total_price = cart.total_price | divided_by: 100 %}
{% assign percent_for_free_delivery = cart_total_price | divided_by: one_percent_for_free_delivery %}
{% assign money_left_for_free_delivery = settings.total_price_for_free_delivery
  | minus: cart_total_price
  | times: 100
  | money_without_currency
  | append: ''
  | replace: '.00', ''
%}

{% liquid
  assign style_left_for_icon = percent_for_free_delivery
  if percent_for_free_delivery >= 94
    assign style_left_for_icon = 94
  endif
%}

{% style %}
  #shopify-section-{{ section.id }} {
    width: 100%;
    height: 100dvh;
    pointer-events: none;
    background: transparent;
    overflow-x: hidden;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 12;
    transition: background 400ms ease;
  }

  #shopify-section-{{ section.id }} .s-side-cart__header-subtext:after {
    {% if settings.enable_free_delivery %}
      width: {{ percent_for_free_delivery }}%;
    {% else %}
      display: none;
    {% endif %}
  }

  #shopify-section-{{ section.id }} .s-side-cart__delivery-icon {
    right: unset;
    left: {{ style_left_for_icon }}%;
  }

  #shopify-section-{{ section.id }} .s-side-cart--rtl .s-side-cart__delivery-icon {
    left: unset;
    right: {{ style_left_for_icon }}%;
  }
{% endstyle %}

{% liquid
  assign rtl = false

  if localization.language.iso_code == 'ar'
    assign rtl = true
  endif

  assign title = section.settings.header_title
  assign empty_title = section.settings.empty_title
  assign empty_text = section.settings.empty_text
  assign empty_cta = section.settings.empty_cta

  if rtl
    assign title = section.settings.header_title_ar | default: title
    assign empty_title = section.settings.empty_title_ar | default: empty_title
    assign empty_text = section.settings.empty_text_ar | default: empty_text
    assign empty_cta = section.settings.empty_cta_ar | default: empty_cta
  endif
%}

<s-side-cart
  class="s-side-cart {% if rtl %}s-side-cart--rtl{% endif %}"
  data-section-id="shopify-section-{{ section.id }}"
  data-id="{{ section.id }}"
  data-cart-json="{{ cart | json | escape }}"
>
  <div class="s-side-cart__overlay js-side-cart__overlay"></div>
  <div class="s-side-cart__wrapper">
    <div class="s-side-cart__inner js-side-cart__inner">
      <div class="s-side-cart__loader js-side-cart__loader"></div>
      <div class="s-side-cart__header {% if cart.item_count == 0 %}s-side-cart__header--empty{% endif %}">
        <div class="s-side-cart__header-text-container">
          <h4 class="s-side-cart__header-title">
            {{ title }}
            <span class="js-side-cart__header-item-count">
              <span class="s-side-cart__header-item-count js-side-cart__header-item-count">
                {% unless cart.empty? %}
                  ({{ cart.item_count }})
                {% endunless %}
              </span>
            </span>
          </h4>
          <div class="s-side-cart__header-subtext js-side-cart__header-subtext">
            {% if cart.item_count > 0 %}
              <p>
                {% if cart_total_price >= settings.total_price_for_free_delivery %}
                  {{ 'sections.side-cart.free_shipping_complete_text' | t }}
                {% else %}
                  {{
                    'sections.side-cart.free_shipping_text'
                    | t: money: money_left_for_free_delivery, currency: shop.currency
                  }}
                {% endif %}
              </p>
            {% endif %}
          </div>
        </div>
        <button class="s-side-cart__button-close js-side-cart__button-close">
          {% render 'icon-close' %}
        </button>

        <div class="s-side-cart__delivery-icon js-side-cart__delivery-icon">
          {% if cart.item_count > 0 %}
            {% render 'icon-delivery-logo' %}
          {% endif %}
        </div>
      </div>
      <div class="s-side-cart__body {% if cart.item_count == 0 %}s-side-cart__body--empty{% endif %}">
        {% if cart.item_count == 0 %}
          <div class="s-side-cart__empty-wrapper">
            <p class="s-side-cart__empty-text">
              {{ empty_text }}
            </p>
            <div class="s-side-cart__empty-placeholder">
              <h2>{{ empty_title }}</h2>
              <a href="{{ routes.root_url }}{% if rtl %}/{% endif %}account/register">
                {{- empty_cta }}
                {% render 'icon-arrow-3' -%}
              </a>
            </div>
          </div>
        {% else %}
          {% for item in cart.items %}
            {% assign product = item.product %}
            {% assign variant = item.variant %}
          {% unless product.tags contains 'package' %}
            {% if product.tags contains 'gwp_free' %}
              <div 
              class="s-side-cart__item js-side-cart__item" 
                data-variant-id="{{ variant.id }}"
                data-item-name="{{ item.title }}"
                data-brand="{{ item.vendor }}"
                data-type="{{ product.type }}"
                data-price="{{ item.final_line_price | money}}"
              >
                <div class="s-side-cart__item-image">
                  {% if item.image != blank %}
                    <a href="{{ item.url }}">
                      {% render 'image-lazy', image: item.image %}
                    </a>
                  {% endif %}

                  {% unless item.product.tags contains 'gift-card' %}
                    {% comment %}
                      Wishlist
                    {% endcomment %}
                  {% endunless %}
                </div>

                <div class="s-side-cart__item-content">
                  <div class="s-side-cart__item-content-top">
                    <a href="{{ product.url }}" class="s-side-cart__item-title">
                      {{ product.title }}
                    </a>
                    <div class="s-side-cart__item-price {% if variant.compare_at_price != blank %}s-side-cart__item-price--red{% endif %}">
                      <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                      <span>{{ item.final_line_price | money_without_currency | floor }}</span>
                    </div>
                  </div>
                  <div class="s-side-cart__item-subtitle">
                    {% if product.metafields.custom.product_description.value != blank %}
                      {{ product.metafields.custom.product_description.value }}
                    {% endif %}
                    {% if variant.compare_at_price != blank %}
                      <div class="s-side-cart__item-price--discount">
                        <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                        <span>
                          {{- variant.compare_at_price | money_without_currency | times: item.quantity -}}
                        </span>
                      </div>
                    {% endif %}
                  </div>
                  <div class="s-side-cart__item-options">
                    <span class="s-side-cart__item-options--text">
                      {{ item.variant_options | join: ',' }}
                      {% for option in item.options_with_values %}
                        {% unless option.value contains 'Default Title' %}
                          {% if forloop.last %}
                            {{ option.name }}
                            {{ option.value }}
                          {% else %}
                            {{ option.name }}
                            {{ option.value | append: ', ' }}
                          {% endif %}
                        {% endunless %}
                      {% endfor %}
                    </span>
                  </div>
                </div>
              </div>
            {% else %}
              {% unless item.product.tags contains 'package' %}
                <div class="s-side-cart__item js-side-cart__item" data-variant-id="{{ item.variant.id }}">
                  <div class="s-side-cart__item-image">
                    {% if item.image != blank %}
                      <a href="{{ item.url }}">
                        {% render 'image-lazy', image: item.image %}
                      </a>
                    {% endif %}
                
                    {% unless item.product.tags contains 'gift-card' %}
                      {% comment %}
                        Wishlist
                      {% endcomment %}
                    {% endunless %}
                  </div>

                  <div class="s-side-cart__item-content">
                    <div class="s-side-cart__item-content-top">
                      <a href="{{ product.url }}" class="s-side-cart__item-title">
                        {{ product.title }}
                      </a>
                      <div class="s-side-cart__item-price {% if variant.compare_at_price != blank %}s-side-cart__item-price--red{% endif %}">
                        <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                        <span>{{ item.final_line_price | money_without_currency  }}</span>
                      </div>
                    </div>
                    <div class="s-side-cart__item-subtitle">
                      {% if product.metafields.custom.product_description.value != blank %}
                        {{ product.metafields.custom.product_description.value }}
                      {% endif %}
                      {% if variant.compare_at_price != blank %}
                        <div class="s-side-cart__item-price--discount">
                          <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                          <span>
                            {{- variant.compare_at_price | money_without_currency  | times: item.quantity -}}
                          </span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="s-side-cart__item-options">
                      <span class="s-side-cart__item-options--text">
                        {{ item.variant_options | join: ',' }}
                        {% for option in item.options_with_values %}
                          {% unless option.value contains 'Default Title' %}
                            {% if forloop.last %}
                              {{ option.name }}
                              {{ option.value }}
                            {% else %}
                              {{ option.name }}
                              {{ option.value | append: ', ' }}
                            {% endif %}
                          {% endunless %}
                        {% endfor %}
                      </span>
                      {% unless product.has_only_default_variant or product.variants.size == 1 %}
                        <button
                          class="s-side-cart__item-options--button js-side-cart__open-variant-picker"
                          data-product-handle="{{ product.handle }}"
                          data-variant-id="{{ variant.id }}"
                          data-item-id="{{ item.id }}"
                        >
                          {{ 'sections.main_cart.edit' | t }}
                        </button>
                      {% endunless %}
                    </div>
                    <div class="s-side-cart__item-bottom">
                      <div class="s-side-cart__item-qty-wrapper">
                        <button
                          class="s-side-cart__item-button-delete js-side-cart__item-button-delete"
                          data-item-id="{{ item.id }}"
                        >
                          {% render 'icon-trash' %}
                        </button>

                        {% liquid
                          assign line_item_limit = item.variant.inventory_quantity

                          if item.product.tags contains 'pre-order'
                            assign line_item_limit = settings.quantity_limit

                            if item.variant.inventory_quantity > 0
                              assign line_item_limit = item.variant.inventory_quantity
                            endif
                          endif
                        %}

                        <div class="s-side-cart__item-quantity js-side-cart__item-quantity s-side-cart__item-input-wrapper">
                          <div class="s-side-cart__form-qty-wrapper">
                            <button
                              type="button"
                              class="s-side-cart__form-qty-button {% if item.quantity == 1 %}s-side-cart__form-qty-button--disabled{% endif %} js-side-cart__form-qty-button--minus"
                            >
                              {% render 'icon-qty-minus' %}
                            </button>
                            <input
                              class="s-side-cart__form-qty-input js-side-cart__form-qty-input"
                              type="number"
                              name="quantity"
                              min="1"
                              step="1"
                              max="{{ line_item_limit }}"
                              value="{{ item.quantity }}"
                            >
                            <button
                              type="button"
                              class="s-side-cart__form-qty-button js-side-cart__form-qty-button--plus {% if line_item_limit <= 1 or item.quantity >= line_item_limit -%} s-side-cart__form-qty-button--disabled {% endif %}"
                            >
                              {% render 'icon-qty-plus' %}
                            </button>
                          </div>
                        </div>
                      </div>
                      {% assign multibuys_offers = product.metafields.custom.offer_pills.value %}

                      {% liquid
                        assign product_offers_tag = ''
                        for tag in product.metafields.custom.tags_list.value
                          assign product_offers_tag = tag | split: ',' | first
                        endfor
                      %}

                      {% if multibuys_offers and multibuys_offers != blank %}
                        <button
                          class="s-side-cart__item-content--offers js-side-cart__open-offers"
                          data-product-handle="{{ product.handle }}"
                          data-variant-id="{{ variant.id }}"
                          data-offer-tag="{{ product_offers_tag | handleize }}"
                          data-offer-title="{{ product_offers_tag }}"
                        >
                          {% for offer in multibuys_offers %}
                            {% if forloop.first %}
                              {{ offer.title }}
                              {% render 'icon-arrow-2' %}
                            {% endif %}
                          {% endfor %}
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endunless %}
            {% endif %}
          {% endunless %}
          {% endfor %}

          {% comment %} Shop the look {% endcomment %}
          {% if cart.items.size == 1 %}
            {% assign shop_the_look_products = product.metafields.custom.shop_the_look.value %}
            {% if shop_the_look_products %}
              <div class="s-side-cart__shop-the-look-wrapper">
                <h5 class="s-side-cart__shop-the-look-title">Add The Look</h5>
                <div class="s-side-cart__shop-the-look-list">
                  {% for product in shop_the_look_products %}
                    <div
                      class="s-side-cart__item s-side-cart__item--border js-side-cart__item"
                      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                    >
                      <div class="s-side-cart__item-image">
                        {% if product.images[0] != blank %}
                          <a href="{{ product.url }}">
                            {% render 'image-lazy', image: product.images[0] %}
                          </a>
                        {% endif %}
                      </div>

                      <div class="s-side-cart__item-content">
                        <div class="s-side-cart__item-content-top">
                          <a href="{{ product.url }}" class="s-side-cart__item-title">
                            {{ product.title }}
                          </a>
                          <div class="s-side-cart__item-price {% if product.compare_at_price != blank %}s-side-cart__item-price--red{% endif %}">
                            <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                            <span>{{ product.price | money_without_currency  }}</span>
                          </div>
                        </div>
                        <div class="s-side-cart__item-subtitle">
                          {% if product.metafields.custom.product_description.value != blank %}
                            {{ product.metafields.custom.product_description.value }}
                          {% endif %}
                          {% if product.compare_at_price_min != 0 %}
                            <div class="s-side-cart__item-price--discount">
                              <span class="s-side-cart__item-price--currency">{{ shop.currency }}</span>
                              <span>
                                {{- product.compare_at_price_min | money_without_currency  -}}
                              </span>
                            </div>
                          {% endif %}
                        </div>
                        <div class="s-side-cart__item-options"></div>
                        <div class="s-side-cart__item-bottom">
                          <button
                            class="s-side-cart__item-options--button s-side-cart__item-options--button--the-look js-side-cart__open-variant-picker"
                            data-product-handle="{{ product.handle }}"
                            data-variant-id="{{ variant.id }}"
                          >
                            {{ 'sections.side-cart.select_size' | t }}
                            {% render 'icon-arrow-3' %}
                          </button>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>

      <div class="s-side-cart__footer {% if cart.item_count == 0 %}s-side-cart__footer--hidden{% endif %}">
        <div class="s-side-cart__subtotal-container">
          <div class="s-side-cart__subtotal-item js-side-cart__total-price">
            <span> {{ 'sections.side-cart.total' | t }} </span>
            <span>
              <span class="s-side-cart__currency">{{ shop.currency }}</span>
              {{ cart.total_price | money_without_currency  }}
            </span>
          </div>
        </div>

        <div class="s-side-cart__footer-buttons">
          <a href="{{ routes.cart_url }}" class="s-side-cart__button-checkout">
            {{ 'sections.side-cart.checkout' | t }}
          </a>
        </div>
      </div>
    </div>

    <div class="s-side-cart__loader js-side-cart__loader"></div>
  </div>
</s-side-cart>

{% schema %}
{
  "name": "Side cart",
  "settings": [
    {
      "type": "text",
      "id": "header_title",
      "label": "Title",
      "default": "Placeholder"
    },
    {
      "type": "text",
      "id": "header_title_ar",
      "label": "Title (AR)",
      "default": "Placeholder"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty text",
      "default": "Your shopping bag is empty"
    },
    {
      "type": "text",
      "id": "empty_text_ar",
      "label": "Empty text (AR)",
      "default": "Your shopping bag is empty"
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "Empty title",
      "default": "Discover & Join The Very Best"
    },
    {
      "type": "text",
      "id": "empty_title_ar",
      "label": "Empty title (AR)",
      "default": "Discover & Join The Very Best"
    },
    {
      "type": "text",
      "id": "empty_cta",
      "label": "Empty cta text",
      "default": "Join Amirah Club"
    },
    {
      "type": "text",
      "id": "empty_cta_ar",
      "label": "Empty cta text (AR)",
      "default": "Join Amirah Club"
    }
  ],
  "limit": 1,
  "enabled_on": { "groups": ["aside"] },
  "presets": [
    {
      "name": "Side Cart"
    }
  ]
}
{% endschema %}
